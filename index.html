<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Thalarion – Das Blutsiegel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #1e1e1e; color: #f0f0f0; }
    header { background: #2b2b2b; padding: 1rem; text-align: center; position: relative; }
    header .title { font-size: 2rem; font-weight: bold; }
    header .subtitle { font-size: 1rem; color: #ccc; }
    #dmButton { position: absolute; right: 1rem; top: 1rem; width: auto; }

    main { display: flex; height: calc(100vh - 100px); }
    nav { width: 300px; background: #252525; padding: 1rem; overflow-y: auto; }
    nav h3 { margin-top: 1rem; border-bottom: 1px solid #444; }
    .entry { padding: 0.3rem; cursor: pointer; border-radius: 4px; }
    .entry:hover { background: #333; }

    section { flex: 1; padding: 2rem; padding-bottom: 5rem; }
    input, textarea, select, button {
      width: 100%; margin-bottom: 0.5rem; padding: 0.4rem;
      background: #333; color: #fff; border: 1px solid #555;
    }
    textarea { height: 220px; }
    .readonly input, .readonly textarea, .readonly select, .readonly button {
      pointer-events: none; opacity: 0.6;
    }

    .placeholder {
      text-align: center;
      color: #aaa;
      font-size: 1.2rem;
      margin-top: 20%;
    }
  </style>
</head>
<body>
<header id="mainHeader">
  <div class="title" style="cursor:pointer;">Thalarion</div>
  <div class="subtitle" style="cursor:pointer;">Das Blutsiegel</div>
  <button id="dmButton" onclick="toggleDM()">DM Login</button>
</header>

<main>
  <nav id="sidebar">
    <input id="search" placeholder="Suche..." oninput="renderSidebar()" />
  </nav>

  <section id="editor" class="readonly">
    <div id="placeholder" class="placeholder">
      Wähle links einen Ort, ein Reich oder einen anderen Eintrag aus,<br>
      um mehr über die Welt von <strong>Thalarion</strong> zu erfahren.
    </div>

    <div id="editorFields" style="display:none;">
      <h3>Eintrag (DM-Modus)</h3>
      <input id="title" placeholder="Name" />
      <select id="type"></select>
      <select id="visibility">
        <option value="player">Spieler sichtbar</option>
        <option value="dm">Nur DM</option>
      </select>

      <div id="toolbar" style="margin-bottom:0.5rem; display:flex; gap:0.3rem; flex-wrap:wrap;">
        <button type="button" onclick="fmt('bold')"><b>B</b></button>
        <button type="button" onclick="fmt('underline')"><u>U</u></button>
        <button type="button" onclick="fmt('italic')"><i>I</i></button>
        <select onchange="fmtValue('fontSize', this.value)">
          <option value="">Größe</option>
          <option value="2">Klein</option>
          <option value="3">Normal</option>
          <option value="5">Groß</option>
          <option value="7">Sehr groß</option>
        </select>
        <input type="color" onchange="fmtValue('foreColor', this.value)" title="Textfarbe" />
      </div>

      <div id="content" contenteditable="true" style="min-height:220px; background:#333; border:1px solid #555; padding:0.5rem;"></div>

      <button onclick="saveEntry()">Speichern</button>
      <button onclick="newEntry()">Neuer Eintrag</button>
      <button onclick="deleteEntry()">Löschen</button>
      <hr>
      <button onclick="exportData()">Export (JSON)</button>
      <input type="file" onchange="importData(event)" />
    </div>

    <div id="viewer" style="display:none;">
      <h2 id="viewTitle"></h2>
      <div id="viewType" style="color:#aaa; margin-bottom:0.5rem;"></div>
      <div id="viewContent" style="white-space:pre-wrap; line-height:1.5;"></div>
    </div>
  </section>
</main>

<script>
function fmt(cmd) { document.execCommand(cmd, false, null); }
function fmtValue(cmd, value) { if (value) document.execCommand(cmd, false, value); }

const PASSWORD = 'meinewelt';
const categories = ['Königreiche','Städte','Landschaften','NPCs','Religionen','Gilden','Magische Orte'];
let expandedCategories = {};

const STORAGE_KEY = 'thalarion_world_data';
let entries = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let currentIndex = null;
let isDM = false;

const editor = document.getElementById('editor');
const editorFields = document.getElementById('editorFields');
const placeholder = document.getElementById('placeholder');
const dmButton = document.getElementById('dmButton');

const typeSelect = document.getElementById('type');
categories.forEach(c => {
  const o = document.createElement('option');
  o.text = c;
  typeSelect.add(o);
});

function toggleDM() {
  if (isDM) {
    isDM = false;
    dmButton.innerText = 'DM Login';
    updateUI();
    return;
  }
  const pw = prompt('DM-Passwort eingeben:');
  if (pw === PASSWORD) {
    isDM = true;
    dmButton.innerText = 'DM Logout';
    updateUI();
  } else alert('Falsches Passwort');
}

function updateUI() {
  if (isDM) editor.classList.remove('readonly');
  else editor.classList.add('readonly');
  renderSidebar();
}

function renderSidebar() {
  const s = document.getElementById('sidebar');
  const query = document.getElementById('search')?.value.toLowerCase() || '';
  s.innerHTML = '';

  const searchInput = document.createElement('input');
  searchInput.id = 'search';
  searchInput.placeholder = 'Suche...';
  searchInput.value = query;
  searchInput.oninput = renderSidebar;
  s.appendChild(searchInput);

  if (isDM) {
    const btn = document.createElement('button');
    btn.innerText = '+ Neuer Eintrag';
    btn.onclick = newEntry;
    s.appendChild(btn);
  }

  categories.forEach(cat => {
    const matchingEntries = entries.filter(e =>
      e.type === cat &&
      (isDM || e.visibility === 'player') &&
      e.title.toLowerCase().includes(query)
    );

    if (query && matchingEntries.length === 0) return;

    const h = document.createElement('h3');
    h.innerText = (expandedCategories[cat] || query ? '▼ ' : '▶ ') + cat;
    h.style.cursor = 'pointer';
    h.onclick = () => {
      expandedCategories[cat] = !expandedCategories[cat];
      renderSidebar();
    };
    s.appendChild(h);

    if (expandedCategories[cat] || query) {
      matchingEntries.forEach(e => {
        const d = document.createElement('div');
        d.className = 'entry';
        d.style.marginLeft = '1rem';
        d.innerText = e.title;
        d.onclick = () => loadEntry(entries.indexOf(e));
        s.appendChild(d);
      });
    }
  });

  localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
}

function loadEntry(i) {
  currentIndex = i;
  const e = entries[i];
  placeholder.style.display = 'none';

  if (isDM) {
    editorFields.style.display = 'block';
    viewer.style.display = 'none';
    title.value = e.title;
    type.value = e.type;
    visibility.value = e.visibility;
    content.innerHTML = e.content || '';
  } else {
    editorFields.style.display = 'none';
    viewer.style.display = 'block';
    viewTitle.innerText = e.title;
    viewType.innerText = e.type;
    viewContent.innerHTML = e.content || '';
  }
}

function newEntry() {
  if (!isDM) return;
  currentIndex = null;
  placeholder.style.display = 'none';
  editorFields.style.display = 'block';
  title.value = '';
  type.value = categories[0];
  visibility.value = 'player';
  content.innerHTML = '';
}

function saveEntry() {
  if (!isDM) return;
  const e = {
    title: title.value,
    type: type.value,
    visibility: visibility.value,
    content: content.innerHTML
  };
  if (!e.title) return alert('Name fehlt');
  if (currentIndex === null) entries.push(e);
  else entries[currentIndex] = e;
  renderSidebar();
}

function deleteEntry() {
  if (!isDM || currentIndex === null) return;
  entries.splice(currentIndex, 1);
  editorFields.style.display = 'none';
  placeholder.style.display = 'block';
  renderSidebar();
}

function exportData() {
  if (!isDM) return;
  const blob = new Blob([JSON.stringify(entries, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'thalarion_world.json';
  a.click();
}

/* ✅ NUR HIER GEÄNDERT */
function importData(ev) {
  if (!isDM) return;
  const file = ev.target.files[0];
  if (!file) return;

  const r = new FileReader();
  r.onload = e => {
    let parsed;
    try {
      parsed = JSON.parse(e.target.result);
    } catch {
      alert('Ungültige JSON-Datei');
      return;
    }

    const data = Array.isArray(parsed)
      ? parsed
      : parsed && Array.isArray(parsed.entries)
        ? parsed.entries
        : null;

    if (!data) return;

    data.forEach(d => {
      if (!d || !d.title || !d.type) return;

      let mappedType = d.type;
      if (mappedType === 'Stadt') mappedType = 'Städte';
      if (mappedType === 'Königreich') mappedType = 'Königreiche';

      if (!categories.includes(mappedType)) return;

      d.type = mappedType;
      if (!d.visibility) d.visibility = 'dm';
      if (!d.content) d.content = '';

      const exists = entries.some(e =>
        e.title === d.title && e.type === d.type
      );

      if (!exists) {
        entries.push(d);
        expandedCategories[d.type] = true;
      }
    });

    document.getElementById('search').value = '';
    renderSidebar();
  };

  r.readAsText(file);
}

updateUI();
</script>
</body>
</html>