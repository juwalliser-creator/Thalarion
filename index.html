<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thalarion ‚Äì Das Blutsiegel</title>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: #f0f0f0;
    }

    header {
      background: #2b2b2b;
      padding: 1rem;
      text-align: center;
      position: relative;
    }

    .title { font-size: 2rem; font-weight: bold; cursor: pointer; }
    .subtitle { font-size: 1rem; color: #ccc; cursor: pointer; }

    #dmButton {
      position: absolute;
      right: 1rem;
      top: 1rem;
    }

    main {
      display: flex;
      height: calc(100vh - 90px);
    }

    nav {
      width: 280px;
      background: #252525;
      padding: 0.8rem;
      overflow-y: auto;
    }

    nav input {
      margin-bottom: 0.8rem;
    }

    nav h3 {
      cursor: pointer;
      margin: 0.8rem 0 0.3rem;
      border-bottom: 1px solid #444;
    }

    .entry {
      padding: 0.4rem;
      margin-left: 1rem;
      cursor: pointer;
      border-radius: 4px;
    }

    .entry:hover {
      background: #333;
    }

    section {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
    }

    input, select, button {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      background: #333;
      color: #fff;
      border: 1px solid #555;
    }

    .readonly input,
    .readonly select,
    .readonly button,
    .readonly [contenteditable] {
      pointer-events: none;
      opacity: 0.6;
    }

    #toolbar button,
    #toolbar select,
    #toolbar input[type=color] {
      width: auto;
    }

    #content {
      min-height: 220px;
      background: #333;
      border: 1px solid #555;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .placeholder {
      text-align: center;
      color: #aaa;
      margin-top: 20%;
    }

    #dmPanel {
      display: none;
      background: #262626;
      border: 1px solid #444;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    /* üì± Mobile */
    @media (max-width: 768px) {
      main { flex-direction: column; height: auto; }
      nav { width: 100%; max-height: 40vh; }
    }
  </style>
</head>

<body>
<header>
  <div class="title" onclick="resetView()">Thalarion</div>
  <div class="subtitle" onclick="resetView()">Das Blutsiegel</div>
  <button id="dmButton" onclick="toggleDM()">DM Login</button>
</header>

<main>
  <nav id="sidebar"></nav>

  <section id="editor" class="readonly">

    <div id="dmPanel">
      <h3>DM-Verwaltung</h3>
      <button onclick="exportData()">üåç Welt exportieren</button>
      <button onclick="document.getElementById('importFile').click()">üì• Welt importieren</button>
      <input id="importFile" type="file" accept=".json" style="display:none" onchange="importData(event)">
    </div>

    <div id="placeholder" class="placeholder">
      W√§hle links einen Eintrag aus, um mehr √ºber die Welt von <b>Thalarion</b> zu erfahren.
    </div>

    <div id="editorFields" style="display:none;">
      <input id="title" placeholder="Name" />
      <select id="type"></select>
      <select id="visibility">
        <option value="player">Spieler sichtbar</option>
        <option value="dm">Nur DM</option>
      </select>

      <div id="toolbar" style="display:flex; gap:0.3rem; flex-wrap:wrap;">
        <button onclick="fmt('bold')"><b>B</b></button>
        <button onclick="fmt('italic')"><i>I</i></button>
        <button onclick="fmt('underline')"><u>U</u></button>
        <select onchange="fmtValue('fontSize', this.value)">
          <option value="">Gr√∂√üe</option>
          <option value="2">Klein</option>
          <option value="3">Normal</option>
          <option value="5">Gro√ü</option>
        </select>
        <input type="color" onchange="fmtValue('foreColor', this.value)">
      </div>

      <div id="content" contenteditable="true"></div>

      <button onclick="saveEntry()">Speichern</button>
      <button onclick="newEntry()">Neuer Eintrag</button>
      <button onclick="deleteEntry()">L√∂schen</button>
    </div>

    <div id="viewer" style="display:none;">
      <h2 id="viewTitle"></h2>
      <div id="viewType" style="color:#aaa;"></div>
      <div id="viewContent"></div>
    </div>
  </section>
</main>

<script>
const PASSWORD = "meinewelt";
const STORAGE_KEY = "thalarion_world_data";
const categories = ["K√∂nigreiche","St√§dte","Landschaften","NPCs","Religionen","Gilden","Magische Orte"];

let entries = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let isDM = false;
let currentIndex = null;
let expanded = {};

const typeSelect = document.getElementById("type");
categories.forEach(c => typeSelect.add(new Option(c, c)));

function fmt(cmd){ document.execCommand(cmd); }
function fmtValue(cmd,val){ if(val) document.execCommand(cmd,false,val); }

function toggleDM(){
  if(isDM){
    isDM=false;
    dmButton.innerText="DM Login";
  } else {
    if(prompt("DM-Passwort:") === PASSWORD){
      isDM=true;
      dmButton.innerText="DM Logout";
    } else return alert("Falsches Passwort");
  }
  updateUI();
}

function updateUI(){
  editor.classList.toggle("readonly", !isDM);
  dmPanel.style.display = isDM ? "block" : "none";
  renderSidebar();
}

function resetView(){
  if(isDM) return;
  placeholder.style.display="block";
  editorFields.style.display="none";
  viewer.style.display="none";
}

function renderSidebar(){
  const s = sidebar;
  s.innerHTML = "";
  const search = document.createElement("input");
  search.placeholder="Suche...";
  search.oninput = renderSidebar;
  s.appendChild(search);

  if(isDM){
    const b=document.createElement("button");
    b.innerText="+ Neuer Eintrag";
    b.onclick=newEntry;
    s.appendChild(b);
  }

  categories.forEach(cat=>{
    const list = entries.filter(e=>e.type===cat && (isDM||e.visibility==="player") && e.title.toLowerCase().includes(search.value.toLowerCase()));
    if(!list.length) return;

    const h=document.createElement("h3");
    h.innerText=(expanded[cat]?"‚ñº ":"‚ñ∂ ")+cat;
    h.onclick=()=>{expanded[cat]=!expanded[cat]; renderSidebar();};
    s.appendChild(h);

    if(expanded[cat]){
      list.forEach(e=>{
        const d=document.createElement("div");
        d.className="entry";
        d.innerText=e.title;
        d.onclick=()=>loadEntry(entries.indexOf(e));
        s.appendChild(d);
      });
    }
  });

  localStorage.setItem(STORAGE_KEY,JSON.stringify(entries));
}

function loadEntry(i){
  currentIndex=i;
  const e=entries[i];
  placeholder.style.display="none";
  if(isDM){
    editorFields.style.display="block";
    viewer.style.display="none";
    title.value=e.title;
    type.value=e.type;
    visibility.value=e.visibility;
    content.innerHTML=e.content||"";
  } else {
    editorFields.style.display="none";
    viewer.style.display="block";
    viewTitle.innerText=e.title;
    viewType.innerText=e.type;
    viewContent.innerHTML=e.content||"";
  }
}

function newEntry(){
  currentIndex=null;
  editorFields.style.display="block";
  placeholder.style.display="none";
  title.value="";
  content.innerHTML="";
}

function saveEntry(){
  const e={title:title.value,type:type.value,visibility:visibility.value,content:content.innerHTML};
  if(!e.title) return alert("Name fehlt");
  currentIndex==null?entries.push(e):entries[currentIndex]=e;
  renderSidebar();
}

function deleteEntry(){
  if(currentIndex==null) return;
  entries.splice(currentIndex,1);
  resetView();
  renderSidebar();
}

function exportData(){
  const blob=new Blob([JSON.stringify(entries,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="thalarion_world.json";
  a.click();
}

function importData(ev){
  const r=new FileReader();
  r.onload=e=>{
    entries=JSON.parse(e.target.result);
    renderSidebar();
    alert("Import erfolgreich");
  };
  r.readAsText(ev.target.files[0]);
}

updateUI();
</script>
</body>
</html>
